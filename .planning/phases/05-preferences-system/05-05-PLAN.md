---
phase: 05-preferences-system
plan: 05
type: execute
wave: 3
depends_on: ["05-02", "05-03", "05-04"]
files_modified:
  - frontend/src/pages/PreferencesSettings.tsx
  - frontend/src/contexts/PreferencesContext.tsx
  - frontend/public/locales/en/settings.json
  - frontend/public/locales/zh-TW/settings.json
autonomous: false
user_setup: []

must_haves:
  truths:
    - "User can find all preference controls organized by category"
    - "User can reset all preferences to defaults with one action"
    - "User sees confirmation before reset to prevent accidents"
    - "Preference changes sync across multiple browser tabs in real-time"
    - "All preference controls work correctly in both English and Traditional Chinese"
  artifacts:
    - path: "frontend/src/pages/PreferencesSettings.tsx"
      provides: "Organized settings UI with reset functionality"
      contains: "resetPreferences"
  key_links:
    - from: "frontend/src/pages/PreferencesSettings.tsx"
      to: "frontend/src/contexts/PreferencesContext.tsx"
      via: "resetPreferences function"
      pattern: "resetPreferences"
---

<objective>
Finalize the Preferences Settings page with organized sections and global reset functionality.

Purpose: Clean, well-organized settings UI that matches user expectations. Global reset provides safety net for users who want to return to defaults. Final verification ensures all pieces work together.

Output: Polished PreferencesSettings page with Appearance/Language/Accessibility sections, reset button with confirmation, and verified cross-tab sync.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-preferences-system/05-CONTEXT.md
@frontend/src/pages/PreferencesSettings.tsx
@frontend/src/contexts/PreferencesContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reorganize settings page sections and add reset button</name>
  <files>
    frontend/src/pages/PreferencesSettings.tsx
    frontend/public/locales/en/settings.json
    frontend/public/locales/zh-TW/settings.json
  </files>
  <action>
Reorganize the PreferencesSettings page to have clear sections and add a global reset button.

**Update PreferencesSettings.tsx:**

The page should now have three Card sections in order:
1. **Appearance** - Theme, Font Size, Display Density
2. **Language** - Language toggle
3. **Accessibility** - Reduced Motion

Add imports for the reset confirmation dialog and Button component:
```typescript
import { Button } from '@/components/ui/button';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from '@/components/ui/alert-dialog';
import { RotateCcw } from 'lucide-react';
```

Add reset functionality at the bottom of the page (after all cards):

```tsx
<div className="mt-8 pt-6 border-t">
  <div className="flex items-center justify-between">
    <div>
      <h3 className="font-medium">{t('preferences.reset.title')}</h3>
      <p className="text-sm text-muted-foreground">
        {t('preferences.reset.description')}
      </p>
    </div>
    <AlertDialog>
      <AlertDialogTrigger asChild>
        <Button variant="outline" className="gap-2">
          <RotateCcw className="h-4 w-4" />
          {t('preferences.reset.button')}
        </Button>
      </AlertDialogTrigger>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>{t('preferences.reset.dialog.title')}</AlertDialogTitle>
          <AlertDialogDescription>
            {t('preferences.reset.dialog.description')}
          </AlertDialogDescription>
        </AlertDialogHeader>
        <AlertDialogFooter>
          <AlertDialogCancel>{t('preferences.reset.dialog.cancel')}</AlertDialogCancel>
          <AlertDialogAction onClick={() => resetPreferences()}>
            {t('preferences.reset.dialog.confirm')}
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  </div>
</div>
```

Ensure resetPreferences is destructured from usePreferences:
```typescript
const { preferences, updatePreferences, resetPreferences } = usePreferences();
```

**Update settings.json translations:**

In `frontend/public/locales/en/settings.json`, add under preferences:
```json
"reset": {
  "title": "Reset Preferences",
  "description": "Reset all preferences to their default values",
  "button": "Reset All",
  "dialog": {
    "title": "Reset All Preferences?",
    "description": "This will reset font size, display density, and reduced motion to their default values. Theme and language preferences are not affected.",
    "cancel": "Cancel",
    "confirm": "Reset All"
  }
}
```

In `frontend/public/locales/zh-TW/settings.json`:
```json
"reset": {
  "title": "重設偏好設定",
  "description": "將所有偏好設定重設為預設值",
  "button": "全部重設",
  "dialog": {
    "title": "確定要重設所有偏好設定？",
    "description": "這將會重設字體大小、顯示密度和減少動態效果至預設值。主題和語言偏好設定不受影響。",
    "cancel": "取消",
    "confirm": "全部重設"
  }
}
```

**Note:** The reset resets what PreferencesContext manages (fontSize, density, reducedMotion). Theme (next-themes) and language (i18next) are managed by separate systems and are not affected.
  </action>
  <verify>
Navigate to Settings > User Preferences.
Verify three clear sections: Appearance, Language, Accessibility.
Verify Reset All button appears at bottom.
Click Reset All - confirmation dialog should appear.
Cancel - nothing changes.
Confirm - preferences reset to defaults.
  </verify>
  <done>
PreferencesSettings page organized into Appearance/Language/Accessibility sections. Reset All button with confirmation dialog added. Translations updated for both languages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify cross-tab synchronization</name>
  <files>frontend/src/contexts/PreferencesContext.tsx</files>
  <action>
Verify that the storage event listener in PreferencesContext properly syncs preferences across tabs, and ensure DOM attributes are updated when receiving external changes.

**Review and update the storage event handler in PreferencesContext.tsx:**

The storage event listener should not only update state, but also apply the preferences to DOM (since the DOM-setting effects only run on state changes from the current tab):

```typescript
// Cross-tab sync via storage event
useEffect(() => {
  const handleStorageChange = (e: StorageEvent) => {
    if (e.key === 'userPreferences' && e.newValue) {
      try {
        const updated = JSON.parse(e.newValue) as UserPreferences;
        setPreferences(updated);

        // Also apply to DOM immediately for CSS custom properties
        // (The normal useEffects will also run, but this ensures immediate update)
        document.documentElement.setAttribute('data-font-size', updated.fontSize);
        document.documentElement.setAttribute('data-density', updated.density);
        if (updated.reducedMotion) {
          document.documentElement.setAttribute('data-reduced-motion', 'true');
        } else {
          document.documentElement.removeAttribute('data-reduced-motion');
        }
      } catch (error) {
        console.error('Failed to parse preferences from storage event:', error);
      }
    }
  };

  window.addEventListener('storage', handleStorageChange);
  return () => window.removeEventListener('storage', handleStorageChange);
}, []);
```

**Note:** The state update via setPreferences will also trigger the individual useEffects for each preference, but that's fine - they will just re-apply the same values. The immediate DOM update in the handler ensures visual sync happens right away without waiting for React re-render.
  </action>
  <verify>
Open two browser tabs to /settings/preferences.
In Tab 1, change font size to Large.
Tab 2 should update to Large without refresh.
In Tab 2, change density to Compact.
Tab 1 should update to Compact without refresh.
Verify visual changes occur in both tabs.
  </verify>
  <done>
Cross-tab sync verified working. Storage event handler updates both React state and DOM attributes when preferences change in another tab.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Preferences System with:
- Font Size control (Small/Medium/Large)
- Display Density control (Compact/Comfortable/Spacious)
- Reduced Motion toggle with system preference detection
- Settings page organized into Appearance/Language/Accessibility sections
- Global reset button with confirmation dialog
- Cross-tab synchronization
- localStorage persistence
- Full English and Traditional Chinese translations
  </what-built>
  <how-to-verify>
1. **Font Size Test:**
   - Navigate to /settings/preferences
   - Change Font Size to Large - verify text scales up across app
   - Navigate to Dashboard, Teachers, Schools - all text should be larger
   - Change to Small - verify text is smaller
   - Return to Medium

2. **Display Density Test:**
   - Change Display Density to Compact - verify tighter spacing
   - Navigate around app - cards and main content should have less padding
   - Change to Spacious - verify more breathing room
   - Return to Comfortable

3. **Reduced Motion Test:**
   - Toggle Reduced Motion ON
   - Switch theme (dark/light) - should be instant, no fade
   - Hover over buttons - no transition effects
   - Toggle OFF - animations should return

4. **Persistence Test:**
   - Set: Large font, Compact density, Reduced Motion ON
   - Hard refresh (Ctrl+Shift+R or Cmd+Shift+R)
   - All settings should persist

5. **Cross-Tab Sync Test:**
   - Open two tabs to /settings/preferences
   - In Tab 1: Change font size to Small
   - Tab 2 should update automatically (visual change + dropdown value)
   - In Tab 2: Toggle Reduced Motion ON
   - Tab 1 should update automatically

6. **Reset Test:**
   - Click "Reset All" button
   - Cancel in dialog - nothing changes
   - Click "Reset All" again, confirm
   - Font Size: Medium, Density: Comfortable, Reduced Motion: OFF

7. **Language Test:**
   - Switch to Traditional Chinese
   - All new labels should be translated (Appearance, Accessibility, etc.)
   - Reset dialog should be in Chinese
   - Switch back to English

8. **System Preference Detection:**
   - If your OS has "Reduce motion" setting:
     - Enable it in OS settings
     - Verify yellow indicator text appears in Settings
     - Disable OS setting - indicator should disappear
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
All verification performed in checkpoint task above.
</verification>

<success_criteria>
1. Settings page shows Appearance, Language, Accessibility sections in clear cards
2. All preference controls (font size, density, reduced motion) work correctly
3. Reset All button resets fontSize/density/reducedMotion to defaults with confirmation
4. Cross-tab sync works for all preferences
5. All settings persist across page refresh
6. English and Traditional Chinese translations complete
7. System reduced motion preference detected and indicated
</success_criteria>

<output>
After completion, create `.planning/phases/05-preferences-system/05-05-SUMMARY.md`
</output>
