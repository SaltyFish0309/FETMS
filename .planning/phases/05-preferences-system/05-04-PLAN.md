---
phase: 05-preferences-system
plan: 04
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - frontend/src/index.css
  - frontend/src/contexts/PreferencesContext.tsx
  - frontend/src/hooks/usePrefersReducedMotion.ts
  - frontend/src/pages/PreferencesSettings.tsx
  - frontend/public/locales/en/settings.json
  - frontend/public/locales/zh-TW/settings.json
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can toggle reduced motion from Settings"
    - "When enabled, all animations and transitions are disabled"
    - "System prefers-reduced-motion preference is detected and shown"
    - "User preference overrides system preference"
    - "Reduced motion preference persists across browser sessions"
  artifacts:
    - path: "frontend/src/index.css"
      provides: "CSS rules to disable animations when data-reduced-motion is set"
      contains: "data-reduced-motion"
    - path: "frontend/src/hooks/usePrefersReducedMotion.ts"
      provides: "Hook to detect system reduced motion preference"
      exports: ["usePrefersReducedMotion"]
    - path: "frontend/src/pages/PreferencesSettings.tsx"
      provides: "Reduced motion toggle UI with system preference indicator"
      contains: "reducedMotion"
  key_links:
    - from: "frontend/src/contexts/PreferencesContext.tsx"
      to: "document.documentElement"
      via: "setAttribute/removeAttribute data-reduced-motion"
      pattern: "data-reduced-motion"
    - from: "frontend/src/pages/PreferencesSettings.tsx"
      to: "frontend/src/hooks/usePrefersReducedMotion.ts"
      via: "usePrefersReducedMotion hook"
      pattern: "usePrefersReducedMotion"
---

<objective>
Implement reduced motion preference for accessibility - users can disable animations and transitions.

Purpose: Essential accessibility feature for users with vestibular disorders, motion sensitivity, or those who simply prefer a calmer interface. Respects system-level preference while allowing user override.

Output: Working reduced motion toggle in Settings that disables all animations/transitions when enabled, with system preference detection.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-preferences-system/05-RESEARCH.md
@.planning/phases/05-preferences-system/05-CONTEXT.md
@frontend/src/index.css
@frontend/src/contexts/PreferencesContext.tsx
@frontend/src/pages/PreferencesSettings.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CSS rules to disable animations when reduced motion enabled</name>
  <files>frontend/src/index.css</files>
  <action>
Update the reduced motion CSS to handle both system preference AND user preference via data attribute.

**The existing code in @layer base has:**
```css
/* Respect reduced motion preference */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    transition-duration: 0.01ms !important;
  }
}
```

**Add user preference override that takes precedence:**

Add after the @media rule (still within @layer base):

```css
/* User reduced motion preference (overrides system setting) */
:root[data-reduced-motion="true"] *,
:root[data-reduced-motion="true"] *::before,
:root[data-reduced-motion="true"] *::after {
  animation: none !important;
  transition: none !important;
}
```

**Why `transition: none` instead of `transition-duration: 0.01ms`:**
Per RESEARCH.md Pitfall 3 - using duration 0 still causes browser to calculate transitions. Using `transition: none` is more performant and completely disables transitions.

**Note:** The user setting uses data-reduced-motion="true" attribute. When not set, animations run normally (unless system preference is reduce, which the @media query handles).
  </action>
  <verify>
Manually add `data-reduced-motion="true"` to html element in DevTools.
Verify theme toggle animation stops (try switching light/dark).
Verify hover effects on buttons no longer animate.
Remove attribute - animations should return.
  </verify>
  <done>
CSS rules disable all animations and transitions when data-reduced-motion="true" is set on :root. System preference still respected via @media query when user hasn't explicitly set preference.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create usePrefersReducedMotion hook for system preference detection</name>
  <files>frontend/src/hooks/usePrefersReducedMotion.ts</files>
  <action>
Create a custom hook that detects the operating system's reduced motion preference.

**Create new file frontend/src/hooks/usePrefersReducedMotion.ts:**

```typescript
import { useState, useEffect } from 'react';

/**
 * Hook to detect system-level prefers-reduced-motion preference.
 * Listens for changes so it updates if user changes OS settings.
 *
 * Based on Josh W. Comeau's pattern from RESEARCH.md.
 */
export function usePrefersReducedMotion(): boolean {
  const [prefersReducedMotion, setPrefersReducedMotion] = useState<boolean>(() => {
    // SSR safety check (not needed for Vite but good practice)
    if (typeof window === 'undefined') return false;

    const mediaQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
    return mediaQuery.matches;
  });

  useEffect(() => {
    const mediaQuery = window.matchMedia('(prefers-reduced-motion: reduce)');

    const handleChange = (event: MediaQueryListEvent) => {
      setPrefersReducedMotion(event.matches);
    };

    // Set initial value (in case lazy initializer ran on server)
    setPrefersReducedMotion(mediaQuery.matches);

    // Listen for changes
    mediaQuery.addEventListener('change', handleChange);

    return () => {
      mediaQuery.removeEventListener('change', handleChange);
    };
  }, []);

  return prefersReducedMotion;
}
```

**Usage:** This hook tells the UI if the system prefers reduced motion, so we can show an indicator to the user in Settings.
  </action>
  <verify>
Import hook in a test component and log the value.
On macOS: System Preferences > Accessibility > Display > Reduce motion
On Windows: Settings > Ease of Access > Display > Show animations
Toggle system setting and verify hook value updates.
  </verify>
  <done>
usePrefersReducedMotion hook exported from frontend/src/hooks/usePrefersReducedMotion.ts. Returns boolean indicating system preference. Listens for changes to update reactively.
  </done>
</task>

<task type="auto">
  <name>Task 3: Apply data-reduced-motion attribute and add UI toggle</name>
  <files>
    frontend/src/contexts/PreferencesContext.tsx
    frontend/src/pages/PreferencesSettings.tsx
    frontend/public/locales/en/settings.json
    frontend/public/locales/zh-TW/settings.json
  </files>
  <action>
**Update PreferencesContext.tsx:**

Modify the persistence useEffect to handle reduced motion attribute:

```typescript
useEffect(() => {
  preferencesService.save(preferences);

  // Apply preferences to DOM for CSS custom properties
  document.documentElement.setAttribute('data-font-size', preferences.fontSize);
  document.documentElement.setAttribute('data-density', preferences.density);

  // Handle reduced motion - set or remove attribute
  if (preferences.reducedMotion) {
    document.documentElement.setAttribute('data-reduced-motion', 'true');
  } else {
    document.documentElement.removeAttribute('data-reduced-motion');
  }
}, [preferences]);
```

**Update PreferencesSettings.tsx:**

1. Add new imports:
```typescript
import { Switch } from '@/components/ui/switch';
import { usePrefersReducedMotion } from '@/hooks/usePrefersReducedMotion';
```

2. Inside component, add hook call:
```typescript
const systemPrefersReducedMotion = usePrefersReducedMotion();
```

3. Add a new Accessibility Card section (after the Language Card):

```tsx
<Card>
  <CardHeader>
    <CardTitle>{t('preferences.sections.accessibility.title')}</CardTitle>
    <CardDescription>
      {t('preferences.sections.accessibility.description')}
    </CardDescription>
  </CardHeader>
  <CardContent className="space-y-4">
    <div className="flex items-center justify-between">
      <Label htmlFor="reduced-motion" className="flex flex-col gap-1">
        <span>{t('preferences.sections.accessibility.reducedMotion.label')}</span>
        <span className="font-normal text-sm text-muted-foreground">
          {t('preferences.sections.accessibility.reducedMotion.description')}
          {systemPrefersReducedMotion && (
            <span className="block text-xs mt-1 text-amber-600 dark:text-amber-400">
              {t('preferences.sections.accessibility.reducedMotion.systemDetected')}
            </span>
          )}
        </span>
      </Label>
      <Switch
        id="reduced-motion"
        checked={preferences.reducedMotion}
        onCheckedChange={(checked) => updatePreferences({ reducedMotion: checked })}
      />
    </div>
  </CardContent>
</Card>
```

**Update settings.json translations:**

In `frontend/public/locales/en/settings.json`, add new section under preferences.sections:
```json
"accessibility": {
  "title": "Accessibility",
  "description": "Configure accessibility options for a more comfortable experience.",
  "reducedMotion": {
    "label": "Reduced Motion",
    "description": "Minimize animations and transitions throughout the interface",
    "systemDetected": "System preference for reduced motion detected"
  }
}
```

In `frontend/public/locales/zh-TW/settings.json`:
```json
"accessibility": {
  "title": "無障礙",
  "description": "設定無障礙選項以獲得更舒適的使用體驗。",
  "reducedMotion": {
    "label": "減少動態效果",
    "description": "減少介面中的動畫和過渡效果",
    "systemDetected": "已偵測到系統偏好減少動態效果"
  }
}
```
  </action>
  <verify>
Navigate to Settings > User Preferences.
New "Accessibility" section should appear with Reduced Motion toggle.
Toggle on - verify animations stop (theme switch, hover effects, etc.).
If system has reduced motion enabled, yellow indicator text should appear.
Refresh page - setting persists.
  </verify>
  <done>
PreferencesContext sets data-reduced-motion attribute when enabled. PreferencesSettings shows Accessibility section with Reduced Motion toggle and system preference indicator. Both English and Traditional Chinese translations added.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /settings/preferences in dev server
2. Verify new Accessibility section appears with Reduced Motion toggle
3. Toggle reduced motion ON:
   - Theme toggle should switch instantly (no fade)
   - Button hover effects should be instant
   - Any loading animations should stop
4. Toggle reduced motion OFF:
   - Animations should return
5. Check system preference detection:
   - Enable system reduced motion preference
   - Verify indicator text appears in Settings
6. Check DevTools: html element has data-reduced-motion="true" when toggle is ON
7. Refresh page - setting persists
8. Switch language to Traditional Chinese - labels translate correctly
9. Run `npm run build --prefix frontend` - builds without errors
</verification>

<success_criteria>
1. Accessibility section with Reduced Motion toggle appears in Settings
2. When enabled, all animations and transitions are disabled
3. System prefers-reduced-motion is detected and indicator shown
4. data-reduced-motion attribute correctly set/removed on html element
5. Reduced motion preference persists in localStorage
6. English and Traditional Chinese translations work
7. No TypeScript or build errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-preferences-system/05-04-SUMMARY.md`
</output>
