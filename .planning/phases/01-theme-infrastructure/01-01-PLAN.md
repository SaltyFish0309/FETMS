---
phase: 01-theme-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/tailwind.config.js
  - frontend/index.html
autonomous: true

must_haves:
  truths:
    - "User switches between Light/Dark/System themes without visual glitches"
    - "Page loads in correct theme without flashing white (FOUC prevented)"
    - "Theme preference persists across browser sessions"
    - "dark: utility classes affect component styling when .dark class is on html"
  artifacts:
    - path: "frontend/tailwind.config.js"
      provides: "Tailwind dark mode configuration"
      contains: "darkMode: 'class'"
    - path: "frontend/index.html"
      provides: "FOUC prevention script"
      contains: "localStorage.getItem('theme')"
  key_links:
    - from: "frontend/index.html"
      to: "localStorage"
      via: "FOUC script reads theme key"
      pattern: "localStorage\\.getItem\\(['\"]theme['\"]\\)"
    - from: "frontend/tailwind.config.js"
      to: "html.dark class"
      via: "darkMode class strategy"
      pattern: "darkMode.*['\"]class['\"]"
---

<objective>
Configure Tailwind CSS dark mode and add FOUC prevention to complete theme infrastructure.

Purpose: Fix the broken dark mode implementation. Currently, `dark:` Tailwind utilities don't work because Tailwind config is missing `darkMode: 'class'`, and users see white flash on page load because there's no FOUC prevention script.

Output: Working dark mode toggle with zero flash on page load and persistent theme preference.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-theme-infrastructure/01-RESEARCH.md

# Source files to modify
@frontend/tailwind.config.js
@frontend/index.html

# Reference files (already correct, don't modify)
@frontend/src/App.tsx
@frontend/src/components/ui/theme-provider.tsx
@frontend/src/components/ui/theme-toggle.tsx
@frontend/src/index.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add darkMode class strategy to Tailwind config</name>
  <files>frontend/tailwind.config.js</files>
  <action>
Add `darkMode: 'class'` to the Tailwind config object. This enables class-based dark mode where `dark:` utility classes only apply when the `.dark` class is present on an ancestor element (html in our case).

Add the line immediately after the opening brace of `export default {`:
```javascript
darkMode: 'class',
```

Keep all other config unchanged. The file should look like:
```javascript
/** @type {import('tailwindcss').Config} */
export default {
    darkMode: 'class',
    content: [
        "./index.html",
        "./src/**/*.{js,ts,jsx,tsx}",
    ],
    // ... rest unchanged
}
```

Why this works: next-themes adds/removes `.dark` class on `<html>` element. Tailwind's `darkMode: 'class'` makes `dark:` variants respond to that class.
  </action>
  <verify>
1. Read the updated file to confirm darkMode line exists
2. Run `npm run build --prefix frontend` to verify Tailwind compiles without errors
  </verify>
  <done>
- tailwind.config.js contains `darkMode: 'class'`
- Frontend builds successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Add FOUC prevention script to index.html</name>
  <files>frontend/index.html</files>
  <action>
Add an inline blocking script at the very top of the `<head>` section (before all other scripts and meta tags). This script reads the theme from localStorage and applies the `.dark` class to `<html>` synchronously before any content renders.

Insert this script immediately after `<head>`:
```html
<script>
  (function() {
    var theme = localStorage.getItem('theme');
    var systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (theme === 'dark' || (theme === 'system' && systemPrefersDark) || (!theme && systemPrefersDark)) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  })();
</script>
```

Place this BEFORE the existing react-grab script.

Why this specific logic:
- `theme === 'dark'`: User explicitly chose dark
- `theme === 'system' && systemPrefersDark`: User chose "System" and OS is in dark mode
- `!theme && systemPrefersDark`: First visit, no preference set, OS prefers dark

Why blocking (not type="module"): Must execute synchronously before CSS loads to prevent flash.

Key: localStorage key must be 'theme' to match ThemeProvider's storageKey prop.
  </action>
  <verify>
1. Read the updated file to confirm script is in correct position
2. Verify script uses correct localStorage key ('theme')
3. Run `npm run dev --prefix frontend` and verify page loads without errors
  </verify>
  <done>
- index.html contains FOUC prevention script in head before other scripts
- Script reads from localStorage key 'theme'
- Script handles all three cases: 'dark', 'system', and undefined
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify complete theme infrastructure</name>
  <files>None (verification only)</files>
  <action>
Verify the entire theme system works end-to-end:

1. Start the development server:
   ```bash
   npm run dev --prefix frontend
   ```

2. Test dark mode toggle works:
   - Open browser at http://localhost:5173
   - Click theme toggle button
   - Verify UI switches between light/dark themes
   - Check DevTools: `<html>` should have `.dark` class when dark mode active

3. Test localStorage persistence:
   - Set theme to dark
   - Open DevTools > Application > Local Storage
   - Verify 'theme' key exists with value 'dark'
   - Refresh page - should stay in dark mode

4. Test FOUC prevention:
   - Set theme to dark
   - Hard refresh (Ctrl+Shift+R or Cmd+Shift+R)
   - Verify NO white flash before dark theme applies
   - Page should load directly in dark mode

5. Test System theme:
   - Select "System" from theme toggle
   - Verify theme follows OS preference
   - Change OS theme (if possible) to verify it updates

6. Verify dark: utilities work:
   - Open DevTools
   - Find any element using `dark:` classes (e.g., theme toggle icons)
   - Toggle `.dark` class on `<html>` manually
   - Verify the `dark:` styles apply/remove correctly

Record any issues found for potential gap closure.
  </action>
  <verify>
1. Dev server runs without errors
2. Theme toggle changes appearance
3. localStorage stores theme preference
4. Hard refresh shows no white flash in dark mode
5. System theme detection works
  </verify>
  <done>
- Theme switching works without visual glitches
- FOUC prevention confirmed (no white flash on hard refresh)
- Theme persists across browser sessions
- dark: utility classes respond to .dark class on html
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify Phase 1 success criteria from ROADMAP.md:

1. **Theme switching**: User switches between Light/Dark/System without glitches
   - Test: Click through all three options in theme toggle
   - Expected: Immediate visual change, no flicker

2. **FOUC prevention**: Page loads in correct theme without white flash
   - Test: Set dark mode, hard refresh (Ctrl+Shift+R)
   - Expected: Page loads dark, no white flash visible

3. **Persistence**: Theme preference persists across sessions
   - Test: Set theme, close browser, reopen
   - Expected: Same theme applied on return

4. **Semantic tokens ready**: Shadcn/UI components can use tokens
   - Test: Check index.css has --background, --foreground, --primary
   - Test: Check components use bg-background, text-foreground classes
   - Expected: Already implemented (verified in research)
</verification>

<success_criteria>
- [ ] tailwind.config.js contains `darkMode: 'class'`
- [ ] index.html contains FOUC prevention script at top of head
- [ ] FOUC script uses localStorage key 'theme' (matches ThemeProvider)
- [ ] Frontend builds without errors
- [ ] Theme toggle works in browser (light/dark/system)
- [ ] Hard refresh in dark mode shows NO white flash
- [ ] Theme preference persists in localStorage
- [ ] dark: utility classes respond to .dark class on html
</success_criteria>

<output>
After completion, create `.planning/phases/01-theme-infrastructure/01-01-SUMMARY.md`
</output>
