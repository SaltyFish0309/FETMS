---
phase: 05-preferences-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/services/preferencesService.ts
  - frontend/src/contexts/PreferencesContext.tsx
  - frontend/src/App.tsx
  - frontend/public/locales/en/common.json
  - frontend/public/locales/zh-TW/common.json
autonomous: true
user_setup: []

must_haves:
  truths:
    - "PreferencesContext provides fontSize, density, and reducedMotion state"
    - "Preferences load from localStorage on app initialization"
    - "Preference changes persist to localStorage immediately"
    - "Corrupted localStorage data shows warning toast and resets to defaults"
  artifacts:
    - path: "frontend/src/services/preferencesService.ts"
      provides: "localStorage abstraction with load/save/getDefaults"
      exports: ["preferencesService", "UserPreferences"]
    - path: "frontend/src/contexts/PreferencesContext.tsx"
      provides: "React context for preferences state management"
      exports: ["PreferencesProvider", "usePreferences"]
  key_links:
    - from: "frontend/src/contexts/PreferencesContext.tsx"
      to: "frontend/src/services/preferencesService.ts"
      via: "import and call preferencesService.load/save"
      pattern: "preferencesService\\.(load|save)"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/contexts/PreferencesContext.tsx"
      via: "PreferencesProvider wrapping app content"
      pattern: "<PreferencesProvider>"
---

<objective>
Create the foundational preferences infrastructure: a preferencesService for localStorage abstraction and PreferencesContext for React state management.

Purpose: Establishes the data layer that all preference controls will use - localStorage persistence with error handling, React context for reactive state updates, and cross-tab synchronization via storage events.

Output: Working preferences infrastructure that stores/loads preferences from localStorage, provides React context hooks, and handles corrupted data gracefully.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-preferences-system/05-RESEARCH.md
@.planning/phases/05-preferences-system/05-CONTEXT.md
@frontend/src/contexts/ProjectContext.tsx
@frontend/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add toast translation keys to locale files</name>
  <files>
    frontend/public/locales/en/common.json
    frontend/public/locales/zh-TW/common.json
  </files>
  <action>
Add toast message translation keys for preferences-related error messages to both locale files.

**Update frontend/public/locales/en/common.json:**

Add a new "toast" section at the root level (alongside "app", "nav", "actions", etc.):

```json
"toast": {
  "preferences": {
    "corrupted": "Preferences corrupted, reset to defaults",
    "saveFailed": "Failed to save preferences"
  }
}
```

**Update frontend/public/locales/zh-TW/common.json:**

Add the same structure with Traditional Chinese translations:

```json
"toast": {
  "preferences": {
    "corrupted": "偏好設定已損壞，已重設為預設值",
    "saveFailed": "儲存偏好設定失敗"
  }
}
```

These keys will be used by preferencesService.ts in Task 2 via the sonner toast library with i18next integration.
  </action>
  <verify>
Validate JSON syntax: `node -e "require('./frontend/public/locales/en/common.json')"` and same for zh-TW.
Run: `npx tsc --noEmit -p frontend` to verify no TypeScript errors.
  </verify>
  <done>
Toast translation keys added to en/common.json and zh-TW/common.json under toast.preferences namespace.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create preferencesService for localStorage abstraction</name>
  <files>frontend/src/services/preferencesService.ts</files>
  <action>
Create a new service file that abstracts localStorage access for user preferences.

**Interface definition:**
```typescript
export interface UserPreferences {
  fontSize: 'small' | 'medium' | 'large';
  density: 'compact' | 'comfortable' | 'spacious';
  reducedMotion: boolean;
}
```

**Constants:**
- STORAGE_KEY = 'userPreferences'
- DEFAULT_PREFERENCES with fontSize: 'medium', density: 'comfortable', reducedMotion: false

**Service methods:**
1. `load(): UserPreferences` - Read from localStorage, parse JSON, validate structure, merge with defaults for missing keys. On parse error or invalid structure: log error, show warning toast via sonner using translation key `t('toast.preferences.corrupted', { ns: 'common' })`, return defaults.

2. `save(preferences: UserPreferences): void` - Stringify and write to localStorage. On error (quota exceeded, etc.): log error, show error toast via sonner using translation key `t('toast.preferences.saveFailed', { ns: 'common' })`.

3. `getDefaults(): UserPreferences` - Return a copy of DEFAULT_PREFERENCES.

**Important for toast translations:** Import i18next and use `i18next.t()` for toast messages:
```typescript
import i18next from 'i18next';
import { toast } from 'sonner';

// In load() error handler:
toast.warning(i18next.t('toast.preferences.corrupted', { ns: 'common' }));

// In save() error handler:
toast.error(i18next.t('toast.preferences.saveFailed', { ns: 'common' }));
```

**Error handling pattern from RESEARCH.md:**
- All localStorage calls wrapped in try-catch
- Toast notifications for user feedback on errors
- Always return valid preferences (defaults as fallback)

Follow the pattern established in projectService.ts but simpler (no API calls, localStorage only).
  </action>
  <verify>
File exists at frontend/src/services/preferencesService.ts with exported preferencesService object and UserPreferences type.
Run: `npx tsc --noEmit -p frontend` to verify TypeScript compiles without errors.
  </verify>
  <done>
preferencesService exports load(), save(), getDefaults() methods and UserPreferences type. All localStorage access is wrapped in try-catch with translated toast notifications on error.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create PreferencesContext with persistence and cross-tab sync</name>
  <files>frontend/src/contexts/PreferencesContext.tsx</files>
  <action>
Create a React context that manages preferences state with localStorage persistence.

**Context value interface:**
```typescript
interface PreferencesContextValue {
  preferences: UserPreferences;
  updatePreferences: (updates: Partial<UserPreferences>) => void;
  resetPreferences: () => void;
}
```

**PreferencesProvider component:**
1. Initialize state with lazy initializer calling preferencesService.load()
2. useEffect to persist to localStorage on preferences change via preferencesService.save()
3. useEffect for cross-tab sync:
   - Listen to window 'storage' event
   - On event where key === 'userPreferences' and newValue exists:
     - Parse newValue JSON (wrapped in try-catch)
     - Update state with parsed preferences
   - Clean up listener on unmount
4. useCallback for updatePreferences - spreads updates over previous state
5. useCallback for resetPreferences - sets state to preferencesService.getDefaults()

**usePreferences hook:**
- Call useContext(PreferencesContext)
- Throw error if context is undefined ("usePreferences must be used within PreferencesProvider")

**Pattern reference:** Follow existing ProjectContext.tsx structure for consistency.
  </action>
  <verify>
File exists at frontend/src/contexts/PreferencesContext.tsx with exported PreferencesProvider and usePreferences.
Run: `npx tsc --noEmit -p frontend` to verify TypeScript compiles.
  </verify>
  <done>
PreferencesContext exports PreferencesProvider component and usePreferences hook. Context provides preferences state, updatePreferences(), and resetPreferences(). Cross-tab sync listens to storage events.
  </done>
</task>

<task type="auto">
  <name>Task 4: Wire PreferencesProvider into App.tsx</name>
  <files>frontend/src/App.tsx</files>
  <action>
Wrap the application with PreferencesProvider to make preferences available throughout.

**Changes to App.tsx:**
1. Add import: `import { PreferencesProvider } from "@/contexts/PreferencesContext";`
2. In App() function, wrap content with PreferencesProvider:
   - PreferencesProvider should be INSIDE ThemeProvider and Router
   - PreferencesProvider should be at the same level as ProjectProvider or wrap it
   - Order: ThemeProvider > Router > PreferencesProvider > ProjectProvider > AppContent

**Rationale:** PreferencesProvider needs to be high enough to wrap all components that might use preferences, but inside Router so it can access navigation if needed. Keeping it alongside ProjectProvider maintains existing patterns.

Provider hierarchy after change:
```jsx
<ThemeProvider>
  <Router>
    <PreferencesProvider>
      <ProjectProvider>
        <AppContent />
      </ProjectProvider>
    </PreferencesProvider>
  </Router>
</ThemeProvider>
```
  </action>
  <verify>
Run: `npm run dev --prefix frontend` and verify app loads without errors.
Open browser DevTools console - no React context errors.
Check localStorage - 'userPreferences' key should appear after first load with default values.
  </verify>
  <done>
App.tsx imports and uses PreferencesProvider. Application loads successfully with preferences context available to all components. Default preferences are saved to localStorage on first load.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit -p frontend` passes
2. Dev server starts: `npm run dev --prefix frontend` without errors
3. localStorage check: Open DevTools > Application > Local Storage > localhost:5173 shows 'userPreferences' key with default JSON
4. Context test: Temporarily add `const { preferences } = usePreferences(); console.log(preferences);` to any component and verify it logs without error
5. Toast translation test: Corrupt localStorage value manually (set to "invalid json") and reload - verify toast shows translated message
</verification>

<success_criteria>
1. preferencesService.ts exports load/save/getDefaults and UserPreferences type
2. PreferencesContext.tsx exports PreferencesProvider and usePreferences hook
3. App.tsx wraps content with PreferencesProvider
4. Default preferences (medium/comfortable/false) appear in localStorage on first load
5. Toast messages use translation keys from common.json
6. No TypeScript errors, no console errors on app load
</success_criteria>

<output>
After completion, create `.planning/phases/05-preferences-system/05-01-SUMMARY.md`
</output>
