---
phase: 03-i18n-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/package.json
  - frontend/src/i18n.ts
  - frontend/src/main.tsx
  - frontend/src/types/i18next.d.ts
  - frontend/public/locales/en/common.json
  - frontend/public/locales/zh-TW/common.json
  - frontend/src/test-setup.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "i18next initializes without errors in console"
    - "Translation keys are type-checked in TypeScript"
    - "Default language loads from browser detection"
    - "Translation files exist in public/locales"
    - "Tests pass with mocked i18n"
  artifacts:
    - path: "frontend/src/i18n.ts"
      provides: "i18next configuration"
      exports: ["default"]
    - path: "frontend/src/types/i18next.d.ts"
      provides: "Type definitions for translations"
    - path: "frontend/public/locales/en/common.json"
      provides: "English translations"
  key_links:
    - from: "frontend/src/main.tsx"
      to: "frontend/src/i18n.ts"
      via: "import and side-effect execution"
---

<objective>
Install and configure the i18next ecosystem for React, set up the translation file structure, and ensure type safety for translation keys.

Purpose: Foundation for bilingual support (English/Traditional Chinese).
Output: Working i18n instance integrated into the app root with type-safe hooks.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@frontend/src/main.tsx
@frontend/src/test-setup.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Dependencies and Configure i18n</name>
  <files>
    frontend/package.json
    frontend/src/i18n.ts
  </files>
  <action>
    1. Install dependencies in frontend:
       `npm install i18next react-i18next i18next-http-backend i18next-browser-languagedetector`
    2. Create `frontend/src/i18n.ts`:
       - Import all plugins.
       - Configure with `use(Backend).use(LanguageDetector).use(initReactI18next)`.
       - Set `fallbackLng: 'en'`.
       - Set `supportedLngs: ['en', 'zh-TW']`.
       - Set `interpolation: { escapeValue: false }` (React handles safety).
       - Configure backend to load from `/locales/{{lng}}/{{ns}}.json`.
  </action>
  <verify>
    Check if node_modules contains i18next packages.
    Check if src/i18n.ts exports the i18n instance.
  </verify>
  <done>
    Dependencies installed and configuration file created.
  </done>
</task>

<task type="auto">
  <name>Task 2: Setup Translation Files and Types</name>
  <files>
    frontend/public/locales/en/common.json
    frontend/public/locales/zh-TW/common.json
    frontend/src/types/i18next.d.ts
    frontend/src/vite-env.d.ts
  </files>
  <action>
    1. Create directory structure `frontend/public/locales/{en,zh-TW}`.
    2. Create `common.json` in both:
       - en: `{ "common": { "welcome": "Welcome", "language": "Language", "settings": "Settings" } }`
       - zh-TW: `{ "common": { "welcome": "歡迎", "language": "語言", "settings": "設定" } }`
    3. Create `frontend/src/types/i18next.d.ts`:
       - Import 'i18next'.
       - Import common.json from public (or define interface manually if json import fails).
       - Extend `CustomTypeOptions` with `defaultNS: 'common'` and `resources`.
       - Ensure strictly typed keys work.
  </action>
  <verify>
    `ls -R frontend/public/locales` shows files.
    TypeScript compiler (`tsc --noEmit`) accepts the new type definition.
  </verify>
  <done>
    Translation files exist and TypeScript knows about the common namespace.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate and Mock</name>
  <files>
    frontend/src/main.tsx
    frontend/src/test-setup.ts
  </files>
  <action>
    1. Modify `frontend/src/main.tsx`:
       - Import `./i18n` (side effect).
       - Import `Suspense` from 'react'.
       - Wrap `<App />` with `<Suspense fallback={<div className="flex items-center justify-center h-screen">Loading...</div>}>`.
    2. Modify `frontend/src/test-setup.ts`:
       - Mock `react-i18next` globally.
       - Mock `useTranslation` to return `{ t: (k: string) => k, i18n: { changeLanguage: () => new Promise(() => {}) } }`.
       - Ensure tests don't fail due to missing Suspense or network requests for locales.
  </action>
  <verify>
    `npm run test` in frontend passes.
    `npm run dev` loads the app without white screen (Suspense working).
  </verify>
  <done>
    App wrapped in Suspense and tests are green.
  </done>
</task>

</tasks>

<verification>
Run `npm run test` in frontend.
Manually check `frontend/src/i18n.ts` for correct config.
</verification>

<success_criteria>
- Dependencies installed.
- i18n initialized in main.tsx.
- Types defined for 'common' namespace.
- Tests passing with mock.
</success_criteria>

<output>
After completion, create `.planning/phases/03-i18n-infrastructure/03-01-SUMMARY.md`
</output>
