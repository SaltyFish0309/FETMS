---
phase: 05-preferences-system
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - frontend/src/index.css
  - frontend/src/contexts/PreferencesContext.tsx
  - frontend/src/pages/PreferencesSettings.tsx
  - frontend/public/locales/en/settings.json
  - frontend/public/locales/zh-TW/settings.json
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can select Compact/Comfortable/Spacious density from Settings"
    - "Density change applies immediately without page refresh"
    - "Component spacing scales appropriately across the application"
    - "Density preference persists across browser sessions"
  artifacts:
    - path: "frontend/src/index.css"
      provides: "CSS custom properties for density-scale"
      contains: "data-density"
    - path: "frontend/src/pages/PreferencesSettings.tsx"
      provides: "Density control UI"
      contains: "density"
  key_links:
    - from: "frontend/src/contexts/PreferencesContext.tsx"
      to: "document.documentElement"
      via: "setAttribute data-density"
      pattern: "setAttribute.*data-density"
    - from: "frontend/src/pages/PreferencesSettings.tsx"
      to: "frontend/src/contexts/PreferencesContext.tsx"
      via: "usePreferences hook"
      pattern: "updatePreferences.*density"
---

<objective>
Implement display density preference control that scales spacing across the application.

Purpose: Users can choose between information-dense layouts (Compact) or more spacious, breathing room layouts (Spacious). Comfortable is the balanced default.

Output: Working density toggle (Compact/Comfortable/Spacious) in Settings with immediate visual effect and localStorage persistence.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-preferences-system/05-RESEARCH.md
@.planning/phases/05-preferences-system/05-CONTEXT.md
@.planning/phases/05-preferences-system/05-02-SUMMARY.md
@frontend/src/index.css
@frontend/src/contexts/PreferencesContext.tsx
@frontend/src/pages/PreferencesSettings.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CSS custom properties for density scaling</name>
  <files>frontend/src/index.css</files>
  <action>
Add CSS custom properties that scale spacing based on data-density attribute.

**Add after the font size scaling section in index.css (Plan 05-02 added font-size scaling, add density after it):**

```css
/* Display Density Scaling */
:root {
  --density-scale: 1;
  --density-padding-sm: calc(0.5rem * var(--density-scale));
  --density-padding: calc(1rem * var(--density-scale));
  --density-padding-lg: calc(1.5rem * var(--density-scale));
  --density-gap-sm: calc(0.5rem * var(--density-scale));
  --density-gap: calc(1rem * var(--density-scale));
  --density-gap-lg: calc(1.5rem * var(--density-scale));
}

:root[data-density="compact"] {
  --density-scale: 0.75;
}

:root[data-density="comfortable"] {
  --density-scale: 1;
}

:root[data-density="spacious"] {
  --density-scale: 1.25;
}
```

**Apply density scaling to key layout elements in @layer base:**

Add rules that apply density scaling to common patterns:

```css
/* Apply density scaling to main content area */
main {
  padding: var(--density-padding-lg) !important;
}

/* Apply density scaling to cards */
.card, [class*="CardContent"], [class*="CardHeader"] {
  padding: var(--density-padding);
}

/* Apply density to common gap utilities */
.space-y-4 > * + * {
  margin-top: var(--density-gap);
}

.space-y-6 > * + * {
  margin-top: var(--density-gap-lg);
}

.gap-4 {
  gap: var(--density-gap);
}

.gap-6 {
  gap: var(--density-gap-lg);
}
```

**Note:** This is a targeted approach. We scale the most impactful spacing (main padding, card padding, common gaps) rather than trying to scale every single spacing value. This provides noticeable density changes without breaking layouts.

**Scaling rationale:**
- compact: 0.75 - tighter spacing, more content visible
- comfortable: 1.0 - default Tailwind spacing
- spacious: 1.25 - more breathing room, easier to scan
  </action>
  <verify>
Manually add `data-density="compact"` to html element in DevTools.
Verify main content area and cards have reduced padding.
Verify `data-density="spacious"` increases spacing.
  </verify>
  <done>
CSS custom properties --density-scale and spacing variables defined. Density variants scale padding and gaps on main content, cards, and common spacing utilities.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add data-density attribute to PreferencesContext</name>
  <files>frontend/src/contexts/PreferencesContext.tsx</files>
  <action>
Extend the DOM attribute effect in PreferencesContext to also set data-density.

**Plan 05-02 added a useEffect for data-font-size. Add a similar effect for data-density:**

```typescript
// Apply density preference to DOM for CSS custom properties
useEffect(() => {
  document.documentElement.setAttribute('data-density', preferences.density);
}, [preferences.density]);
```

**Alternative (consolidate into one effect):** If preferred, you can combine with the font-size effect into a single effect that applies all DOM attributes:

```typescript
// Apply all preferences to DOM for CSS custom properties
useEffect(() => {
  document.documentElement.setAttribute('data-font-size', preferences.fontSize);
  document.documentElement.setAttribute('data-density', preferences.density);
}, [preferences.fontSize, preferences.density]);
```

Either approach is acceptable. The key is that data-density is set on the html element.
  </action>
  <verify>
Run dev server, open DevTools Elements tab.
Check that `<html>` element has both `data-font-size="medium"` and `data-density="comfortable"` attributes.
Verify the density CSS applies correctly.
  </verify>
  <done>
PreferencesContext sets data-density attribute on document.documentElement whenever preferences.density changes. Initial load applies default or stored density.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add density control UI to PreferencesSettings</name>
  <files>
    frontend/src/pages/PreferencesSettings.tsx
    frontend/public/locales/en/settings.json
    frontend/public/locales/zh-TW/settings.json
  </files>
  <action>
Add a display density selector to the Appearance section of PreferencesSettings.

**Update PreferencesSettings.tsx:**

The imports for usePreferences and Select components should already exist from Plan 05-02. If not, ensure they're present:
```typescript
import { usePreferences } from '@/contexts/PreferencesContext';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
```

Add density control inside the Appearance Card's CardContent (after the font size control added by Plan 05-02):

```tsx
<div className="flex items-center justify-between">
  <Label htmlFor="density" className="flex flex-col gap-1">
    <span>{t('preferences.sections.appearance.density.label')}</span>
    <span className="font-normal text-sm text-muted-foreground">
      {t('preferences.sections.appearance.density.description')}
    </span>
  </Label>
  <Select
    value={preferences.density}
    onValueChange={(value: 'compact' | 'comfortable' | 'spacious') =>
      updatePreferences({ density: value })
    }
  >
    <SelectTrigger id="density" className="w-[140px]">
      <SelectValue />
    </SelectTrigger>
    <SelectContent>
      <SelectItem value="compact">{t('preferences.sections.appearance.density.compact')}</SelectItem>
      <SelectItem value="comfortable">{t('preferences.sections.appearance.density.comfortable')}</SelectItem>
      <SelectItem value="spacious">{t('preferences.sections.appearance.density.spacious')}</SelectItem>
    </SelectContent>
  </Select>
</div>
```

**Update settings.json translations:**

In `frontend/public/locales/en/settings.json`, add under preferences.sections.appearance (alongside the fontSize object):
```json
"density": {
  "label": "Display Density",
  "description": "Adjust spacing and padding across the interface",
  "compact": "Compact",
  "comfortable": "Comfortable",
  "spacious": "Spacious"
}
```

In `frontend/public/locales/zh-TW/settings.json`, add same structure:
```json
"density": {
  "label": "顯示密度",
  "description": "調整介面的間距和留白",
  "compact": "緊湊",
  "comfortable": "舒適",
  "spacious": "寬鬆"
}
```
  </action>
  <verify>
Navigate to Settings > User Preferences in the browser.
Display Density dropdown should appear below Font Size.
Select "Compact" - spacing should visibly tighten.
Select "Spacious" - spacing should increase.
Refresh page - setting should persist.
  </verify>
  <done>
PreferencesSettings shows Display Density selector with Compact/Comfortable/Spacious options. Selection updates immediately and persists across sessions. Both English and Traditional Chinese translations added.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /settings/preferences in dev server
2. Verify Display Density dropdown appears in Appearance section (below Font Size)
3. Select each option (Compact/Comfortable/Spacious) and verify spacing changes
4. Check main content padding changes
5. Check card padding changes
6. Refresh page - density setting persists
7. Check DevTools: html element has correct data-density attribute
8. Switch language to Traditional Chinese - labels translate correctly
9. Run `npm run build --prefix frontend` - builds without errors
</verification>

<success_criteria>
1. Display Density selector appears in Preferences Settings page
2. Selecting Compact/Comfortable/Spacious visibly changes spacing across app
3. data-density attribute updates on html element
4. Density persists in localStorage and survives page refresh
5. English and Traditional Chinese translations work
6. No TypeScript or build errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-preferences-system/05-03-SUMMARY.md`
</output>
